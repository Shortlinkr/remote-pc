<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Viewer</title>
</head>
<body>
<video id="remote" autoplay playsinline controls></video>
<script>
const signaling = new WebSocket('wss://remotepc.caleb-martinez.workers.dev/');
let pc = new RTCPeerConnection();

signaling.onmessage = async ev => {
  const m = JSON.parse(ev.data);
  if (m.type === 'offer') {
    await pc.setRemoteDescription(new RTCSessionDescription(m.offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    signaling.send(JSON.stringify({to:'broadcaster', type:'answer', answer:answer}));
  }
  if (m.type === 'ice') {
    await pc.addIceCandidate(new RTCIceCandidate(m.candidate));
  }
};

pc.onicecandidate = e => {
  if (e.candidate)
    signaling.send(JSON.stringify({to:'broadcaster', type:'ice', candidate:e.candidate}));
};

pc.ontrack = e => {
  document.getElementById('remote').srcObject = e.streams[0];
};

signaling.onopen = () => {
  signaling.send(JSON.stringify({type:'register', role:'viewer'}));
};
</script>
</body>
</html>
  }
  if(m.type === 'ice'){ await pc.addIceCandidate(new RTCIceCandidate(m.candidate)); }
});

const overlay = document.getElementById('overlay');
overlay.focus();

overlay.addEventListener('pointerdown', e => sendPointer('down', e));
overlay.addEventListener('pointerup', e => sendPointer('up', e));
overlay.addEventListener('pointermove', e => sendPointer('move', e));
overlay.addEventListener('wheel', e => {
  if(dc && dc.readyState==='open') dc.send(JSON.stringify({type:'wheel', deltaX:e.deltaX, deltaY:e.deltaY}));
  e.preventDefault();
});

window.addEventListener('keydown', e => { if(dc && dc.readyState==='open') dc.send(JSON.stringify({type:'key', k:e.key, code:e.code, down:true})); });
window.addEventListener('keyup', e => { if(dc && dc.readyState==='open') dc.send(JSON.stringify({type:'key', k:e.key, code:e.code, down:false})); });

function sendPointer(action, e){
  if(!dc || dc.readyState !== 'open') return;
  const rect = document.getElementById('remote').getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width;
  const y = (e.clientY - rect.top) / rect.height;
  dc.send(JSON.stringify({type:'mouse', action, x, y, button:e.button}));
}
</script>
</body>
</html>
