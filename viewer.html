<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Viewer</title>
<style>
html, body { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:system-ui; }
#remote { width:100%; height:100%; object-fit:contain; background:#222; }
#overlay { position:absolute; top:0; left:0; right:0; bottom:0; }
</style>
</head>
<body>
<video id="remote" autoplay playsinline></video>
<div id="overlay" tabindex="0"></div>
<script>
const signaling = new WebSocket('wss://remotepc.caleb-martinez.workers.dev/');
let pc;
let dc;

signaling.addEventListener('open', ()=> signaling.send(JSON.stringify({type:'register', role:'viewer'})));
signaling.addEventListener('message', async ev=>{
  const m = JSON.parse(ev.data);
  if(m.type === 'offer'){
    pc = new RTCPeerConnection();
    pc.ontrack = e => document.getElementById('remote').srcObject = e.streams[0];
    pc.onicecandidate = e => { if(e.candidate) signaling.send(JSON.stringify({to:'broadcaster', type:'ice', candidate:e.candidate})); };
    
    dc = pc.createDataChannel('control');
    dc.onopen = ()=>console.log('control channel open');
    dc.onclose = ()=>console.log('control channel closed');
    
    await pc.setRemoteDescription(new RTCSessionDescription(m.offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    signaling.send(JSON.stringify({to:'broadcaster', type:'answer', answer:answer}));
  }
  if(m.type === 'ice'){ await pc.addIceCandidate(new RTCIceCandidate(m.candidate)); }
});

const overlay = document.getElementById('overlay');
overlay.focus();

overlay.addEventListener('pointerdown', e => sendPointer('down', e));
overlay.addEventListener('pointerup', e => sendPointer('up', e));
overlay.addEventListener('pointermove', e => sendPointer('move', e));
overlay.addEventListener('wheel', e => {
  if(dc && dc.readyState==='open') dc.send(JSON.stringify({type:'wheel', deltaX:e.deltaX, deltaY:e.deltaY}));
  e.preventDefault();
});

window.addEventListener('keydown', e => { if(dc && dc.readyState==='open') dc.send(JSON.stringify({type:'key', k:e.key, code:e.code, down:true})); });
window.addEventListener('keyup', e => { if(dc && dc.readyState==='open') dc.send(JSON.stringify({type:'key', k:e.key, code:e.code, down:false})); });

function sendPointer(action, e){
  if(!dc || dc.readyState !== 'open') return;
  const rect = document.getElementById('remote').getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width;
  const y = (e.clientY - rect.top) / rect.height;
  dc.send(JSON.stringify({type:'mouse', action, x, y, button:e.button}));
}
</script>
</body>
</html>
